! This file is part of tblite.
! SPDX-Identifier: LGPL-3.0-or-later
!
! tblite is free software: you can redistribute it and/or modify it under
! the terms of the GNU Lesser General Public License as published by
! the Free Software Foundation, either version 3 of the License, or
! (at your option) any later version.
!
! tblite is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
! GNU Lesser General Public License for more details.
!
! You should have received a copy of the GNU Lesser General Public License
! along with tblite.  If not, see <https://www.gnu.org/licenses/>.

!> @dir tblite/ceh/ceh.f90
!> Contains the specification of the Charge Extended HÃ¼ckel (CEH) method.

module tblite_ceh_ceh
   use mctc_env, only : error_type, wp
   use mctc_io, only: structure_type
   use tblite_basis_ortho, only : orthogonalize
   use tblite_basis_slater, only : slater_to_gauss
   use tblite_basis_type, only : cgto_type, new_basis, basis_type
   use tblite_ncoord, only : new_ncoord
   use tblite_context, only : context_type
   use tblite_output_format, only: format_string
   use tblite_integral_type, only : integral_type, new_integral
   use tblite_wavefunction, only : new_wavefunction
   use tblite_xtb_spec, only : tb_h0spec
   use tblite_xtb_calculator, only : xtb_calculator
   use tblite_xtb_h0, only : new_hamiltonian

   implicit none
   private

   public :: ceh_h0spec, new_ceh_calculator

   integer, parameter, private :: max_elem = 86
   integer, parameter, private :: max_shell = 3

   !> Number of shells # MM/TF, Jan 10, 2024 (d-shell for Mg and no d-shell for group 12)
   integer, parameter :: nshell(max_elem) = [&
   & 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 2, 3, & ! 1-20
   & 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, & ! 21-40
   & 3, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, & ! 41-60
   & 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, & ! 61-80
   & 3, 3, 3, 3, 3, 3]                                             ! 81-86

   !> Angular momentum of each shell # MM/TF, Jan 10, 2024)
   ! 0 = s, 1 = p, 2 = d
   ! CAUTION: Ordering from original CEH model is taken for consistency with the parameterization
   ! I.e., the ordering of the shells is always: "s", "p", "d"
   integer, parameter :: ang_shell(max_shell, max_elem) = reshape([&
   & 0, 0, 0,  0, 0, 0,  0, 1, 0,  0, 1, 0,  0, 1, 0,  0, 1, 0,  0, 1, 0, & ! 1-7
   & 0, 1, 0,  0, 1, 0,  0, 1, 0,  0, 1, 0,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 8-14
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 0,  0, 1, 2,  0, 1, 2, & ! 15-21
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 22-28
   & 0, 1, 2,  0, 1, 0,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 29-35
   & 0, 1, 2,  0, 1, 0,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 36-42
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 0,  0, 1, 2, & ! 43-49
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 0,  0, 1, 2, & ! 50-56
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 57-63
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 64-70
   & 0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 71-77
   & 0, 1, 2,  0, 1, 2,  0, 1, 0,  0, 1, 2,  0, 1, 2,  0, 1, 2,  0, 1, 2, & ! 78-84
   & 0, 1, 2,  0, 1, 2], shape(ang_shell))                                  ! 85-86

   !> Principal quantum number of each shell (see commeent above regarding angular momentum)
   integer, parameter :: principal_quantum_number(max_shell, max_elem) = reshape([&
   & 1, 0, 0,  1, 0, 0,  2, 2, 0,  2, 2, 0,  2, 2, 0,  2, 2, 0,  2, 2, 0, & ! 1-7
   & 2, 2, 0,  2, 2, 0,  2, 2, 0,  3, 3, 0,  3, 3, 3,  3, 3, 3,  3, 3, 3, & ! 8-14
   & 3, 3, 3,  3, 3, 3,  3, 3, 3,  3, 3, 3,  4, 4, 0,  4, 4, 3,  4, 4, 3, & ! 15-21
   & 4, 4, 3,  4, 4, 3,  4, 4, 3,  4, 4, 3,  4, 4, 3,  4, 4, 3,  4, 4, 3, & ! 22-28
   & 4, 4, 3,  4, 4, 0,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4, & ! 29-35
   & 4, 4, 4,  5, 5, 0,  5, 5, 4,  5, 5, 4,  5, 5, 4,  5, 5, 4,  5, 5, 4, & ! 36-42
   & 5, 5, 4,  5, 5, 4,  5, 5, 4,  5, 5, 4,  5, 5, 4,  5, 5, 0,  5, 5, 5, & ! 43-49
   & 5, 5, 5,  5, 5, 5,  5, 5, 5,  5, 5, 5,  5, 5, 5,  6, 6, 0,  6, 6, 5, & ! 50-56
   & 6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5, & ! 57-63
   & 6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5, & ! 64-70
   & 6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5, & ! 71-77
   & 6, 6, 5,  6, 6, 5,  6, 6, 0,  6, 6, 5,  6, 6, 5,  6, 6, 5,  6, 6, 5, & ! 78-84
   & 6, 6, 5,  6, 6, 5], shape(principal_quantum_number))                   ! 85-86

   !> Number of primitive gaussians per shell # MM, August 01, 2023
   integer, parameter :: number_of_primitives(max_shell, max_elem) = reshape([&
   & 4, 0, 0,  4, 0, 0,  4, 4, 0,  4, 4, 0,  4, 4, 0,  4, 4, 0,  4, 4, 0, & ! 1-7
   & 4, 4, 0,  4, 4, 0,  4, 4, 0,  4, 4, 0,  4, 4, 4,  4, 4, 4,  4, 4, 4, & ! 8-14
   & 4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 0,  4, 4, 4,  4, 4, 4, & ! 15-21
   & 4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4, & ! 22-28
   & 4, 4, 4,  4, 4, 0,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4, & ! 29-35
   & 4, 4, 4,  4, 4, 0,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4, & ! 36-42
   & 4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 0,  4, 4, 4, & ! 43-49
   & 4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  4, 4, 4,  6, 6, 0,  6, 6, 4, & ! 50-56
   & 6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4, & ! 57-63
   & 6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4, & ! 64-70
   & 6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4, & ! 71-77
   & 6, 6, 4,  6, 6, 4,  6, 6, 0,  6, 6, 4,  6, 6, 4,  6, 6, 4,  6, 6, 4, & ! 78-84
   & 6, 6, 4,  6, 6, 4], shape(number_of_primitives))                       ! 85-86

   !> Reference occupation of the atom
   real(wp), parameter :: reference_occ(max_shell, max_elem) = reshape([&
   & 1.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 0.0_wp,  1.0_wp, 0.0_wp, 0.0_wp, & ! 1-3
   & 2.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 1.0_wp, 0.0_wp,  2.0_wp, 2.0_wp, 0.0_wp, & ! 4-6
   & 2.0_wp, 3.0_wp, 0.0_wp,  2.0_wp, 4.0_wp, 0.0_wp,  2.0_wp, 5.0_wp, 0.0_wp, & ! 7-9
   & 2.0_wp, 6.0_wp, 0.0_wp,  1.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 0.0_wp, & ! 10-12
   & 2.0_wp, 1.0_wp, 0.0_wp,  2.0_wp, 2.0_wp, 0.0_wp,  2.0_wp, 3.0_wp, 0.0_wp, & ! 13-15
   & 2.0_wp, 4.0_wp, 0.0_wp,  2.0_wp, 5.0_wp, 0.0_wp,  2.0_wp, 6.0_wp, 0.0_wp, & ! 16-18
   & 1.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 19-21
   & 2.0_wp, 0.0_wp, 2.0_wp,  2.0_wp, 0.0_wp, 3.0_wp,  2.0_wp, 0.0_wp, 4.0_wp, & ! 22-24
   & 2.0_wp, 0.0_wp, 5.0_wp,  2.0_wp, 0.0_wp, 6.0_wp,  2.0_wp, 0.0_wp, 7.0_wp, & ! 25-27
   & 2.0_wp, 0.0_wp, 8.0_wp,  2.0_wp, 0.0_wp, 9.0_wp,  2.0_wp, 0.0_wp, 0.0_wp, & ! 28-30
   & 2.0_wp, 1.0_wp, 0.0_wp,  2.0_wp, 2.0_wp, 0.0_wp,  2.0_wp, 3.0_wp, 0.0_wp, & ! 31-33
   & 2.0_wp, 4.0_wp, 0.0_wp,  2.0_wp, 5.0_wp, 0.0_wp,  2.0_wp, 6.0_wp, 0.0_wp, & ! 34-36
   & 1.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 37-39
   & 2.0_wp, 0.0_wp, 2.0_wp,  2.0_wp, 0.0_wp, 3.0_wp,  2.0_wp, 0.0_wp, 4.0_wp, & ! 40-42
   & 2.0_wp, 0.0_wp, 5.0_wp,  2.0_wp, 0.0_wp, 6.0_wp,  2.0_wp, 0.0_wp, 7.0_wp, & ! 43-45
   & 2.0_wp, 0.0_wp, 8.0_wp,  2.0_wp, 0.0_wp, 9.0_wp,  2.0_wp, 0.0_wp, 0.0_wp, & ! 46-48
   & 2.0_wp, 1.0_wp, 0.0_wp,  2.0_wp, 2.0_wp, 0.0_wp,  2.0_wp, 3.0_wp, 0.0_wp, & ! 49-51
   & 2.0_wp, 4.0_wp, 0.0_wp,  2.0_wp, 5.0_wp, 0.0_wp,  2.0_wp, 6.0_wp, 0.0_wp, & ! 52-54
   & 1.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 55-57
   & 2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 58-60
   & 2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 61-63
   & 2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 64-66
   & 2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp, & ! 67-69
   & 2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 1.0_wp,  2.0_wp, 0.0_wp, 2.0_wp, & ! 70-72
   & 2.0_wp, 0.0_wp, 3.0_wp,  2.0_wp, 0.0_wp, 4.0_wp,  2.0_wp, 0.0_wp, 5.0_wp, & ! 73-75
   & 2.0_wp, 0.0_wp, 6.0_wp,  2.0_wp, 0.0_wp, 7.0_wp,  2.0_wp, 0.0_wp, 8.0_wp, & ! 76-78
   & 2.0_wp, 0.0_wp, 9.0_wp,  2.0_wp, 0.0_wp, 0.0_wp,  2.0_wp, 1.0_wp, 0.0_wp, & ! 79-81
   & 2.0_wp, 2.0_wp, 0.0_wp,  2.0_wp, 3.0_wp, 0.0_wp,  2.0_wp, 4.0_wp, 0.0_wp, & ! 82-84
   & 2.0_wp, 5.0_wp, 0.0_wp,  2.0_wp, 6.0_wp, 0.0_wp], shape(reference_occ))     ! 85-86

   !> Exponent of the Slater function # MM/TF, Jan 10, 2024
   real(wp), parameter :: slater_exponent(max_shell, max_elem) = reshape([&
   &  1.23363166_wp,  0.00000000_wp,  0.00000000_wp,  2.27004605_wp,  0.00000000_wp,  0.00000000_wp, &
   &  0.86185456_wp,  1.42017184_wp,  0.00000000_wp,  1.76817995_wp,  1.44095844_wp,  0.00000000_wp, &
   &  2.06339837_wp,  1.52051807_wp,  0.00000000_wp,  2.56058582_wp,  1.86484737_wp,  0.00000000_wp, &
   &  2.71233631_wp,  2.19848968_wp,  0.00000000_wp,  3.21585650_wp,  2.41309737_wp,  0.00000000_wp, &
   &  3.82146807_wp,  2.63063636_wp,  0.00000000_wp,  4.62721228_wp,  2.53599954_wp,  0.00000000_wp, &
   &  0.93221172_wp,  1.55333839_wp,  0.00000000_wp,  1.77220557_wp,  1.59942632_wp,  2.98596647_wp, &
   &  2.26040231_wp,  1.78718151_wp,  2.00990188_wp,  1.85259089_wp,  1.81733349_wp,  1.65269988_wp, &
   &  2.65701241_wp,  2.03189759_wp,  2.03883661_wp,  2.60609998_wp,  2.16530440_wp,  2.41888232_wp, &
   &  2.78818934_wp,  2.24732894_wp,  1.99081182_wp,  2.55424399_wp,  2.20946190_wp,  1.93619550_wp, &
   &  1.73713827_wp,  1.33788617_wp,  0.00000000_wp,  2.47982574_wp,  1.07250770_wp,  2.11920764_wp, &
   &  2.22449249_wp,  1.55418319_wp,  2.00953578_wp,  2.58879616_wp,  0.99441077_wp,  1.88561781_wp, &
   &  3.04370654_wp,  4.03007600_wp,  1.66329169_wp,  2.25012727_wp,  2.70681556_wp,  1.67501904_wp, &
   &  2.20605319_wp,  2.82019792_wp,  1.86102254_wp,  1.57297015_wp,  1.98621494_wp,  2.83790684_wp, &
   &  1.80826602_wp,  1.73675835_wp,  2.79767448_wp,  2.00758945_wp,  2.25075692_wp,  2.98291663_wp, &
   &  2.18159986_wp,  2.38459096_wp,  3.09502522_wp,  2.26376756_wp,  2.20362977_wp,  0.00000000_wp, &
   &  2.63822153_wp,  2.06752328_wp,  2.11361643_wp,  2.52891955_wp,  2.19441794_wp,  1.77661998_wp, &
   &  3.55667605_wp,  2.42075463_wp,  1.46579772_wp,  2.89652631_wp,  2.45421858_wp,  2.27883625_wp, &
   &  3.28921099_wp,  2.56526915_wp,  1.64501640_wp,  5.20988189_wp,  2.84336725_wp,  2.75838814_wp, &
   &  1.26972917_wp,  1.88730596_wp,  0.00000000_wp,  1.86880714_wp,  1.78546342_wp,  2.16012236_wp, &
   &  0.92001877_wp,  1.45732462_wp,  2.22901395_wp,  6.50647305_wp,  1.43202338_wp,  2.11971490_wp, &
   &  2.10973371_wp,  2.79944781_wp,  2.01897369_wp,  2.58413333_wp,  3.02795359_wp,  2.08733665_wp, &
   &  2.62141555_wp,  3.13487625_wp,  2.13259872_wp,  2.73984499_wp,  2.18167834_wp,  2.54609647_wp, &
   &  1.84057176_wp,  2.97482636_wp,  3.10693700_wp,  1.75622839_wp,  3.39424756_wp,  3.20265306_wp, &
   &  3.05018811_wp,  2.34951987_wp,  3.35332952_wp,  2.41999128_wp,  2.28892954_wp,  0.00000000_wp, &
   &  2.87813961_wp,  2.44659724_wp,  2.75773502_wp,  3.03823214_wp,  2.32082155_wp,  1.77513328_wp, &
   &  2.68750711_wp,  2.38565373_wp,  2.12596190_wp,  2.81071790_wp,  2.45274786_wp,  2.01871821_wp, &
   &  2.90686956_wp,  2.49377102_wp,  1.90073732_wp,  4.17531340_wp,  2.86937955_wp,  2.96894812_wp, &
   &  1.24299361_wp,  1.99142040_wp,  0.00000000_wp,  1.31400366_wp,  1.16438481_wp,  2.12759606_wp, &
   &  2.81737350_wp,  1.69863323_wp,  2.27369715_wp,  2.84503901_wp,  1.46018192_wp,  2.53498936_wp, &
   &  2.81697107_wp,  1.47545307_wp,  2.54350275_wp,  2.78890313_wp,  1.49072422_wp,  2.55201615_wp, &
   &  2.76083520_wp,  1.50599537_wp,  2.56052955_wp,  2.73276726_wp,  1.52126652_wp,  2.56904294_wp, &
   &  2.70469932_wp,  1.53653767_wp,  2.57755634_wp,  2.67663138_wp,  1.55180881_wp,  2.58606974_wp, &
   &  2.64856345_wp,  1.56707996_wp,  2.59458313_wp,  2.62049551_wp,  1.58235111_wp,  2.60309653_wp, &
   &  2.59242757_wp,  1.59762226_wp,  2.61160992_wp,  2.56435964_wp,  1.61289341_wp,  2.62012332_wp, &
   &  2.53629170_wp,  1.62816456_wp,  2.62863672_wp,  2.50822376_wp,  1.64343571_wp,  2.63715011_wp, &
   &  2.48015583_wp,  1.65870685_wp,  2.64566351_wp,  3.19537752_wp,  2.24853837_wp,  2.41492177_wp, &
   &  3.14122020_wp,  2.48723489_wp,  2.21933576_wp,  3.17661283_wp,  3.39538568_wp,  2.37502789_wp, &
   &  3.14538352_wp,  2.58361113_wp,  2.47139347_wp,  1.81565647_wp,  2.48106221_wp,  3.18585355_wp, &
   &  2.11798490_wp,  2.85857032_wp,  3.47048400_wp,  2.71241232_wp,  3.37886078_wp,  3.64124964_wp, &
   &  2.80572458_wp,  2.82570220_wp,  3.72064445_wp,  2.61951362_wp,  2.69607886_wp,  0.00000000_wp, &
   &  3.05383193_wp,  2.61683803_wp,  3.32179612_wp,  3.02135073_wp,  2.59250246_wp,  4.24674489_wp, &
   &  3.16405210_wp,  2.63238785_wp,  3.04625573_wp,  2.96133467_wp,  2.71388453_wp,  2.31022562_wp, &
   &  2.98240599_wp,  2.95960758_wp,  2.43778345_wp,  3.07936232_wp,  2.68589775_wp,  2.10311395_wp],&
   & shape(slater_exponent))

   !> Atomic shell energy level # MM/TF, Jan 10, 2024
   real(wp), parameter :: p_ceh_selfenergy(max_shell, max_elem) = reshape([&
   & -0.50000000_wp,  0.00000000_wp,  0.00000000_wp, -0.58604129_wp,  0.00000000_wp,  0.00000000_wp, &
   & -0.46026810_wp, -0.39400676_wp,  0.00000000_wp, -0.50992019_wp, -0.41134972_wp,  0.00000000_wp, &
   & -0.52841876_wp, -0.43863719_wp,  0.00000000_wp, -0.58859623_wp, -0.44213431_wp,  0.00000000_wp, &
   & -0.53979133_wp, -0.47418997_wp,  0.00000000_wp, -0.51594238_wp, -0.49018049_wp,  0.00000000_wp, &
   & -0.53034554_wp, -0.52621123_wp,  0.00000000_wp, -0.64405032_wp, -0.58555567_wp,  0.00000000_wp, &
   & -0.46343534_wp, -0.36669501_wp,  0.00000000_wp, -0.50909260_wp, -0.40245930_wp, -0.38169585_wp, &
   & -0.55475700_wp, -0.44136832_wp, -0.10799165_wp, -0.53762836_wp, -0.45800561_wp, -0.24603434_wp, &
   & -0.53956312_wp, -0.47974067_wp, -0.24066447_wp, -0.55307633_wp, -0.50227786_wp, -0.29166202_wp, &
   & -0.60654876_wp, -0.52119815_wp, -0.26180296_wp, -0.73057994_wp, -0.56312353_wp, -0.29028261_wp, &
   & -0.46058178_wp, -0.27726259_wp,  0.00000000_wp, -0.50353553_wp, -0.24169053_wp, -0.40709198_wp, &
   & -0.48547364_wp, -0.27508863_wp, -0.43219791_wp, -0.45874836_wp, -0.29855397_wp, -0.45795781_wp, &
   & -0.38652611_wp, -0.03153419_wp, -0.47247328_wp, -0.48258759_wp, -0.03290445_wp, -0.46968856_wp, &
   & -0.44980636_wp, -0.41770473_wp, -0.47943553_wp, -0.47368110_wp, -0.31441159_wp, -0.49396321_wp, &
   & -0.45795833_wp, -0.29519708_wp, -0.51000414_wp, -0.53908109_wp, -0.33087837_wp, -0.49798795_wp, &
   & -0.49777912_wp, -0.38056469_wp, -0.53147635_wp, -0.52751635_wp, -0.40040729_wp,  0.00000000_wp, &
   & -0.55777561_wp, -0.43659809_wp, -0.11464977_wp, -0.54398501_wp, -0.45713611_wp, -0.21861932_wp, &
   & -0.51826411_wp, -0.47988066_wp, -0.00069757_wp, -0.51041434_wp, -0.50383746_wp, -0.35726678_wp, &
   & -0.55290435_wp, -0.51866152_wp, -0.21491794_wp, -1.44928918_wp, -0.55101134_wp, -0.39004202_wp, &
   & -0.44446788_wp, -0.39498777_wp,  0.00000000_wp, -0.46475931_wp, -0.44931829_wp, -0.38429899_wp, &
   & -0.51172040_wp, -0.29559993_wp, -0.43226517_wp, -0.47606761_wp, -0.29116061_wp, -0.45368955_wp, &
   & -0.45090698_wp, -0.09850215_wp, -0.46406591_wp, -0.46155614_wp, -0.40517287_wp, -0.46906325_wp, &
   & -0.49908468_wp, -0.05135390_wp, -0.48152098_wp, -0.45880003_wp, -0.29166892_wp, -0.49749628_wp, &
   & -0.47289476_wp, -0.40204673_wp, -0.49912575_wp, -0.42563528_wp, -0.37515735_wp, -0.55281195_wp, &
   & -0.48871171_wp, -0.33506060_wp, -0.53536495_wp, -0.53517942_wp, -0.38368710_wp,  0.00000000_wp, &
   & -0.52851597_wp, -0.44064408_wp,  0.02097463_wp, -0.54254396_wp, -0.45516014_wp, -0.02269071_wp, &
   & -0.50881842_wp, -0.48237482_wp, -0.32916461_wp, -0.51340616_wp, -0.50559031_wp, -0.32949183_wp, &
   & -0.65177050_wp, -0.51904347_wp, -0.29655870_wp, -0.69656492_wp, -0.54157320_wp, -0.38942955_wp, &
   & -0.44470586_wp, -0.40619018_wp,  0.00000000_wp, -0.48872721_wp, -0.40983468_wp, -0.38694394_wp, &
   & -0.36050617_wp, -0.34903299_wp, -0.45077902_wp, -0.36089440_wp, -0.36342929_wp, -0.45587299_wp, &
   & -0.35301120_wp, -0.36911131_wp, -0.45504355_wp, -0.34512801_wp, -0.37479333_wp, -0.45421411_wp, &
   & -0.33724482_wp, -0.38047535_wp, -0.45338466_wp, -0.32936163_wp, -0.38615737_wp, -0.45255522_wp, &
   & -0.32147844_wp, -0.39183939_wp, -0.45172578_wp, -0.31359524_wp, -0.39752141_wp, -0.45089633_wp, &
   & -0.30571205_wp, -0.40320343_wp, -0.45006689_wp, -0.29782886_wp, -0.40888545_wp, -0.44923745_wp, &
   & -0.28994567_wp, -0.41456748_wp, -0.44840800_wp, -0.28206247_wp, -0.42024950_wp, -0.44757856_wp, &
   & -0.27417928_wp, -0.42593152_wp, -0.44674912_wp, -0.26629609_wp, -0.43161354_wp, -0.44591967_wp, &
   & -0.25841290_wp, -0.43729556_wp, -0.44509023_wp, -0.49174803_wp, -0.29959854_wp, -0.45177937_wp, &
   & -0.50854411_wp, -0.18518704_wp, -0.45283424_wp, -0.48059967_wp, -0.22456592_wp, -0.47406990_wp, &
   & -0.53510986_wp, -0.34754468_wp, -0.47643022_wp, -0.46243520_wp, -0.33887406_wp, -0.50360536_wp, &
   & -0.46214937_wp, -0.39731207_wp, -0.50615284_wp, -0.47480772_wp, -0.36971594_wp, -0.52380693_wp, &
   & -0.50534466_wp, -0.35273543_wp, -0.53487808_wp, -0.53314521_wp, -0.39316569_wp,  0.00000000_wp, &
   & -0.54584768_wp, -0.43400543_wp,  0.01641365_wp, -0.54660396_wp, -0.45596115_wp, -0.38285028_wp, &
   & -0.46338153_wp, -0.48964439_wp, -0.40056370_wp, -0.51631740_wp, -0.50052770_wp, -0.32225277_wp, &
   & -0.68851644_wp, -0.52305417_wp, -0.31792434_wp, -0.62202646_wp, -0.54262441_wp, -0.31884282_wp],&
   & shape(p_ceh_selfenergy))

   !> Dependence of orbital shell energy level on standard CN (shell-resolved) # MM/TF, Jan 10, 2024
   real(wp), parameter :: p_ceh_kcn(max_shell, max_elem) = reshape([&
   & -0.01527426_wp,  0.00000000_wp,  0.00000000_wp, -0.20385461_wp,  0.00000000_wp,  0.00000000_wp, &
   &  0.09583759_wp, -0.00256132_wp,  0.00000000_wp,  0.02668717_wp, -0.00203134_wp,  0.00000000_wp, &
   & -0.00875987_wp,  0.00007570_wp,  0.00000000_wp,  0.00119277_wp, -0.03101172_wp,  0.00000000_wp, &
   & -0.05812104_wp, -0.06431562_wp,  0.00000000_wp, -0.11856024_wp, -0.13393834_wp,  0.00000000_wp, &
   & -0.14878173_wp, -0.25665520_wp,  0.00000000_wp,  0.00354346_wp, -0.44671891_wp,  0.00000000_wp, &
   &  0.16786019_wp, -0.00714131_wp,  0.00000000_wp,  0.03251420_wp,  0.00251715_wp, -0.00002291_wp, &
   &  0.01284914_wp,  0.02035056_wp, -0.11029404_wp, -0.00004884_wp, -0.00607044_wp, -0.00003212_wp, &
   & -0.01280653_wp, -0.01215365_wp, -0.00122760_wp, -0.02702474_wp, -0.03418553_wp, -0.00010699_wp, &
   &  0.00774898_wp, -0.05210549_wp, -0.01231084_wp,  0.00132705_wp, -0.04786381_wp, -0.00409906_wp, &
   &  0.23520004_wp,  0.00666259_wp,  0.00000000_wp,  0.10470061_wp, -0.00085511_wp,  0.01968353_wp, &
   & -0.03827732_wp, -0.00178315_wp,  0.02855605_wp,  0.07243767_wp,  0.00379858_wp, -0.00037879_wp, &
   & -0.01980662_wp,  0.00019761_wp, -0.00650293_wp, -0.02488553_wp, -0.06782008_wp,  0.00680456_wp, &
   & -0.03817237_wp, -0.00159482_wp, -0.00058460_wp,  0.00210175_wp, -0.01023699_wp, -0.00519605_wp, &
   & -0.01959075_wp, -0.03813321_wp, -0.00473744_wp,  0.11688124_wp, -0.02390089_wp, -0.05469750_wp, &
   &  0.06409570_wp, -0.00155530_wp, -0.07087955_wp,  0.04868008_wp, -0.02220229_wp,  0.00000000_wp, &
   &  0.00104565_wp,  0.02041438_wp, -0.08188253_wp, -0.00952628_wp, -0.00142839_wp, -0.00168100_wp, &
   & -0.03622078_wp, -0.00980793_wp, -0.00511610_wp, -0.05755279_wp, -0.01548897_wp,  0.01027437_wp, &
   & -0.01659613_wp, -0.03868778_wp, -0.01602226_wp, -0.08821382_wp, -0.06900005_wp,  0.03148410_wp, &
   &  0.24851134_wp,  0.00623089_wp,  0.00000000_wp,  0.01808874_wp,  0.07816222_wp, -0.00667252_wp, &
   &  0.11910767_wp,  0.00632764_wp, -0.00019878_wp,  0.04984076_wp,  0.00845567_wp, -0.00317772_wp, &
   & -0.00850138_wp, -0.04110017_wp, -0.00213557_wp, -0.00715588_wp,  0.03161235_wp, -0.00126767_wp, &
   & -0.08590704_wp, -0.08869080_wp, -0.00011589_wp, -0.04031618_wp, -0.01385855_wp, -0.00197567_wp, &
   &  0.00247046_wp,  0.00241706_wp, -0.02597536_wp,  0.01301345_wp, -0.05880852_wp,  0.00031067_wp, &
   &  0.04473053_wp,  0.00258837_wp, -0.07912143_wp,  0.04272801_wp, -0.02217983_wp,  0.00000000_wp, &
   & -0.01457837_wp,  0.02514358_wp, -0.18037990_wp,  0.00009336_wp, -0.00250227_wp, -0.01646118_wp, &
   & -0.02158872_wp, -0.00627793_wp,  0.01169490_wp, -0.02678120_wp, -0.00530212_wp,  0.01330062_wp, &
   &  0.06140083_wp, -0.01269867_wp, -0.01545730_wp, -0.03171125_wp, -0.04598644_wp,  0.02107911_wp, &
   &  0.44152764_wp,  0.05543318_wp,  0.00000000_wp,  0.03946037_wp,  0.01932146_wp,  0.00107582_wp, &
   &  0.00066507_wp,  0.00164582_wp,  0.00982013_wp, -0.00087845_wp, -0.01429165_wp,  0.01269838_wp, &
   & -0.00507490_wp, -0.01010324_wp,  0.01205695_wp, -0.00927134_wp, -0.00591483_wp,  0.01141552_wp, &
   & -0.01346779_wp, -0.00172642_wp,  0.01077409_wp, -0.01766423_wp,  0.00246199_wp,  0.01013267_wp, &
   & -0.02186068_wp,  0.00665040_wp,  0.00949124_wp, -0.02605712_wp,  0.01083881_wp,  0.00884981_wp, &
   & -0.03025357_wp,  0.01502722_wp,  0.00820838_wp, -0.03445001_wp,  0.01921563_wp,  0.00756695_wp, &
   & -0.03864646_wp,  0.02340404_wp,  0.00692552_wp, -0.04284290_wp,  0.02759245_wp,  0.00628410_wp, &
   & -0.04703935_wp,  0.03178086_wp,  0.00564267_wp, -0.05123579_wp,  0.03596927_wp,  0.00500124_wp, &
   & -0.05543224_wp,  0.04015768_wp,  0.00435981_wp, -0.02263884_wp, -0.00002712_wp,  0.02593234_wp, &
   & -0.00733086_wp, -0.02923262_wp,  0.00391616_wp, -0.00787506_wp, -0.00170171_wp, -0.00108316_wp, &
   &  0.01331667_wp, -0.02068325_wp, -0.00399715_wp, -0.01452239_wp, -0.01468235_wp, -0.00769444_wp, &
   & -0.03277240_wp,  0.00149689_wp, -0.01349074_wp,  0.00281174_wp, -0.01604023_wp, -0.03465423_wp, &
   &  0.02800138_wp, -0.00189445_wp, -0.05118473_wp,  0.00930861_wp, -0.00139825_wp,  0.00000000_wp, &
   &  0.01894797_wp,  0.00265353_wp, -0.12534156_wp, -0.02251734_wp,  0.00196977_wp, -0.01613439_wp, &
   & -0.06117570_wp,  0.00051876_wp,  0.02375994_wp, -0.04504086_wp, -0.00431815_wp,  0.00307322_wp, &
   &  0.07498508_wp, -0.00247056_wp, -0.01948869_wp, -0.01832060_wp, -0.00945349_wp,  0.00016993_wp],&
   & shape(p_ceh_kcn))

   !> Dependence of orbital shell energy level on EN-weighted CN (atom-resolved) # MM/TF, Jan 10, 2024
   real(wp), parameter :: p_ceh_kcn_en(max_shell, max_elem) = reshape([&
   & -0.18287122_wp,  0.00000000_wp,  0.00000000_wp, -0.30755913_wp,  0.00000000_wp,  0.00000000_wp, &
   &  0.01275110_wp,  0.00162421_wp,  0.00000000_wp,  0.00064851_wp, -0.00059023_wp,  0.00000000_wp, &
   & -0.01429899_wp, -0.03978279_wp,  0.00000000_wp,  0.00938049_wp, -0.10797031_wp,  0.00000000_wp, &
   & -0.17698493_wp, -0.12470169_wp,  0.00000000_wp, -0.24004477_wp, -0.19353403_wp,  0.00000000_wp, &
   & -0.17474953_wp, -0.28979402_wp,  0.00000000_wp,  0.04813312_wp, -0.31434557_wp,  0.00000000_wp, &
   &  0.01186126_wp,  0.03411291_wp,  0.00000000_wp,  0.05862544_wp, -0.00790869_wp, -0.02905977_wp, &
   &  0.10880322_wp, -0.06762431_wp,  0.14646422_wp,  0.01822081_wp, -0.01136241_wp,  0.00016816_wp, &
   & -0.00756317_wp, -0.03729270_wp,  0.06442043_wp, -0.08983944_wp, -0.05220338_wp,  0.11130204_wp, &
   &  0.00343048_wp, -0.01412173_wp, -0.00074607_wp,  0.00920050_wp,  0.03474317_wp, -0.08548462_wp, &
   & -0.01925628_wp,  0.02119350_wp,  0.00000000_wp,  0.04462912_wp,  0.01113090_wp,  0.00051489_wp, &
   &  0.09356015_wp, -0.06083943_wp,  0.02388012_wp,  0.08841600_wp, -0.05795039_wp,  0.00020811_wp, &
   &  0.14157104_wp, -0.23154387_wp, -0.03192558_wp,  0.00004524_wp, -0.01365641_wp, -0.03295674_wp, &
   & -0.12472036_wp,  0.25753783_wp, -0.04545869_wp, -0.00127590_wp, -0.07984159_wp, -0.01856436_wp, &
   &  0.16810219_wp, -0.00318343_wp, -0.06865441_wp, -0.00402733_wp,  0.01489412_wp, -0.00077046_wp, &
   &  0.18414909_wp,  0.01885653_wp,  0.04116746_wp,  0.01714718_wp,  0.00718330_wp,  0.00000000_wp, &
   &  0.13672473_wp, -0.06347332_wp,  0.02083081_wp,  0.00373718_wp,  0.00305585_wp,  0.00629225_wp, &
   &  0.08972609_wp, -0.03597585_wp, -0.13734663_wp, -0.04555814_wp,  0.00019157_wp,  0.05698306_wp, &
   &  0.19234569_wp,  0.07436030_wp, -0.23635216_wp, -0.03195237_wp, -0.03052000_wp, -0.03245513_wp, &
   & -0.04050766_wp, -0.02241236_wp,  0.00000000_wp,  0.00141471_wp,  0.09825804_wp, -0.02199693_wp, &
   &  0.00118339_wp,  0.00033412_wp,  0.01299094_wp, -0.00480190_wp, -0.08847286_wp,  0.01123888_wp, &
   &  0.03232620_wp,  0.00029098_wp, -0.02881013_wp, -0.06460580_wp,  0.02306576_wp, -0.00490865_wp, &
   & -0.03754636_wp,  0.56088511_wp, -0.04865097_wp, -0.12200786_wp, -0.13994016_wp, -0.00202293_wp, &
   &  0.20125229_wp, -0.01380339_wp, -0.06236270_wp, -0.00245182_wp, -0.14214231_wp,  0.11571303_wp, &
   &  0.06103266_wp, -0.00050633_wp,  0.04808537_wp,  0.07473873_wp, -0.01462049_wp,  0.00000000_wp, &
   &  0.03813866_wp,  0.01640117_wp,  0.00695320_wp,  0.05954850_wp, -0.03472442_wp, -0.13625527_wp, &
   & -0.01747176_wp,  0.00663427_wp, -0.03771232_wp,  0.00123101_wp,  0.01444559_wp, -0.03538416_wp, &
   & -0.06613715_wp,  0.07233085_wp, -0.11265787_wp, -0.01844077_wp, -0.01106546_wp, -0.00759785_wp, &
   & -0.10904365_wp, -0.08340608_wp,  0.00000000_wp,  0.07075042_wp,  0.00117999_wp, -0.00090958_wp, &
   &  0.00247601_wp,  0.00167240_wp,  0.00013598_wp, -0.00095013_wp,  0.02642386_wp, -0.01012395_wp, &
   & -0.00097936_wp,  0.02450455_wp, -0.00929972_wp, -0.00100860_wp,  0.02258524_wp, -0.00847548_wp, &
   & -0.00103783_wp,  0.02066593_wp, -0.00765125_wp, -0.00106706_wp,  0.01874662_wp, -0.00682701_wp, &
   & -0.00109630_wp,  0.01682731_wp, -0.00600277_wp, -0.00112553_wp,  0.01490800_wp, -0.00517854_wp, &
   & -0.00115477_wp,  0.01298869_wp, -0.00435430_wp, -0.00118400_wp,  0.01106938_wp, -0.00353006_wp, &
   & -0.00121324_wp,  0.00915007_wp, -0.00270583_wp, -0.00124247_wp,  0.00723076_wp, -0.00188159_wp, &
   & -0.00127170_wp,  0.00531144_wp, -0.00105735_wp, -0.00130094_wp,  0.00339213_wp, -0.00023312_wp, &
   & -0.00133017_wp,  0.00147282_wp,  0.00059112_wp,  0.05528070_wp, -0.08494378_wp,  0.02939391_wp, &
   &  0.03758259_wp, -0.00308398_wp, -0.03455573_wp, -0.02809771_wp, -0.07288393_wp, -0.01692558_wp, &
   & -0.07551413_wp,  0.09132682_wp, -0.03091809_wp, -0.18624499_wp, -0.01900537_wp,  0.02167696_wp, &
   &  0.00699867_wp,  0.00342261_wp, -0.03365413_wp,  0.00383480_wp, -0.00664512_wp, -0.00061461_wp, &
   &  0.07771353_wp, -0.07519971_wp,  0.04985702_wp,  0.11421175_wp, -0.02452451_wp,  0.00000000_wp, &
   & -0.00147165_wp, -0.00383882_wp, -0.00670568_wp, -0.00214467_wp, -0.00207205_wp, -0.00255896_wp, &
   & -0.03503192_wp,  0.00691206_wp, -0.00070363_wp, -0.02752788_wp,  0.00305398_wp,  0.02512117_wp, &
   & -0.06806315_wp,  0.05828751_wp, -0.07163555_wp, -0.00029628_wp,  0.11996529_wp, -0.13259347_wp],&
   & shape(p_ceh_kcn_en))

   !> Interaction type- and atom-wise resolved scal. fact. for overlap mat. elements # MM/TF, Jan 10, 2024
   real(wp), parameter :: p_ceh_h0k(max_shell, max_elem) = reshape([&
   &  1.75789589_wp,  0.00000000_wp,  0.00000000_wp,  2.45109384_wp,  0.00000000_wp,  0.00000000_wp, &
   &  2.07153694_wp,  0.78968410_wp,  0.00000000_wp,  2.03164560_wp,  1.68894499_wp,  0.00000000_wp, &
   &  1.89530410_wp,  1.77442358_wp,  0.00000000_wp,  2.01978384_wp,  2.07733567_wp,  0.00000000_wp, &
   &  1.84964164_wp,  2.05557276_wp,  0.00000000_wp,  2.02023234_wp,  2.20546986_wp,  0.00000000_wp, &
   &  2.30312078_wp,  2.22016726_wp,  0.00000000_wp,  2.77132517_wp,  2.03429048_wp,  0.00000000_wp, &
   &  2.52726659_wp,  0.82607975_wp,  0.00000000_wp,  2.14234420_wp,  1.47635318_wp,  2.00000000_wp, &
   &  2.17389664_wp,  1.83408625_wp,  3.00000000_wp,  1.89260350_wp,  1.65914746_wp,  4.00000000_wp, &
   &  1.92956477_wp,  2.12764425_wp,  4.00000000_wp,  1.92548361_wp,  2.27843060_wp,  4.00000000_wp, &
   &  1.90414351_wp,  2.17269705_wp,  4.00000000_wp,  1.98594906_wp,  2.34959160_wp,  4.00000000_wp, &
   &  3.98417077_wp,  0.64112460_wp,  0.00000000_wp,  3.24018398_wp,  1.29680491_wp,  2.00000000_wp, &
   &  2.44605447_wp,  1.73192427_wp,  2.00000000_wp,  2.03658364_wp,  1.45032810_wp,  1.70000000_wp, &
   &  1.41066812_wp,  1.32439194_wp,  2.80000000_wp,  1.40658255_wp,  1.37595678_wp,  3.20000000_wp, &
   &  1.31240476_wp,  1.37896793_wp,  3.50000000_wp,  1.66975149_wp,  2.59104378_wp,  1.50000000_wp, &
   &  1.65055570_wp,  2.43059323_wp,  1.00000000_wp,  1.93098919_wp,  3.08848534_wp,  1.00000000_wp, &
   &  2.00594114_wp,  2.92858095_wp,  2.00000000_wp,  1.99879780_wp,  1.73091537_wp,  0.00000000_wp, &
   &  2.13543487_wp,  1.96931111_wp,  4.00000000_wp,  2.03463157_wp,  1.97803362_wp,  4.00000000_wp, &
   &  2.16947011_wp,  2.56278934_wp,  4.00000000_wp,  1.95483393_wp,  2.11433245_wp,  4.00000000_wp, &
   &  2.10503737_wp,  2.57084672_wp,  4.00000000_wp,  2.30195825_wp,  2.76949199_wp,  4.00000000_wp, &
   &  2.28938077_wp,  0.94998126_wp,  0.00000000_wp,  1.96180500_wp,  0.56597428_wp,  4.00000000_wp, &
   &  2.45108472_wp,  1.51630696_wp,  1.00000000_wp,  1.93876482_wp,  1.53881968_wp,  1.00000000_wp, &
   &  1.53300348_wp,  1.38932103_wp,  3.00000000_wp,  1.51641512_wp,  1.73768715_wp,  2.50000000_wp, &
   &  1.42514013_wp,  1.52310017_wp,  2.00000000_wp,  1.46400484_wp,  1.71546678_wp,  2.00000000_wp, &
   &  1.60856488_wp,  2.96212690_wp,  1.00000000_wp,  1.67536563_wp,  3.60206626_wp,  1.00000000_wp, &
   &  2.33168563_wp,  2.89451917_wp,  3.00000000_wp,  2.06675385_wp,  2.04989660_wp,  0.00000000_wp, &
   &  2.51773934_wp,  2.53353496_wp,  2.00000000_wp,  2.04855422_wp,  2.23387968_wp,  2.50000000_wp, &
   &  1.74400850_wp,  1.58280196_wp,  3.00000000_wp,  1.90965983_wp,  2.00280141_wp,  1.00000000_wp, &
   &  1.88267164_wp,  2.02466872_wp,  2.50000000_wp,  1.87654293_wp,  3.82153374_wp,  2.50000000_wp, &
   &  2.29253961_wp,  0.87990580_wp,  0.00000000_wp,  1.77298561_wp,  1.28685734_wp,  1.00000000_wp, &
   &  1.88049469_wp,  1.29599814_wp,  1.00000000_wp,  1.94488157_wp,  1.05010340_wp,  1.00000000_wp, &
   &  1.94668967_wp,  1.05916324_wp,  1.00000000_wp,  1.94849776_wp,  1.06822308_wp,  1.00000000_wp, &
   &  1.95030586_wp,  1.07728292_wp,  1.00000000_wp,  1.95211395_wp,  1.08634276_wp,  1.00000000_wp, &
   &  1.95392204_wp,  1.09540260_wp,  1.00000000_wp,  1.95573014_wp,  1.10446244_wp,  1.00000000_wp, &
   &  1.95753823_wp,  1.11352228_wp,  1.00000000_wp,  1.95934633_wp,  1.12258212_wp,  1.00000000_wp, &
   &  1.96115442_wp,  1.13164196_wp,  1.00000000_wp,  1.96296251_wp,  1.14070180_wp,  1.00000000_wp, &
   &  1.96477061_wp,  1.14976165_wp,  1.00000000_wp,  1.96657870_wp,  1.15882149_wp,  1.00000000_wp, &
   &  1.96838680_wp,  1.16788133_wp,  1.00000000_wp,  1.97194894_wp,  1.64076223_wp,  1.00000000_wp, &
   &  1.63455998_wp,  1.36221654_wp,  2.00000000_wp,  1.53131288_wp,  1.64898042_wp,  2.50000000_wp, &
   &  1.45046663_wp,  1.50024464_wp,  3.50000000_wp,  1.56699829_wp,  2.15927840_wp,  1.00000000_wp, &
   &  1.55163553_wp,  2.37202410_wp,  1.00000000_wp,  1.76371259_wp,  3.19912109_wp,  1.00000000_wp, &
   &  2.05294513_wp,  3.20472848_wp,  1.00000000_wp,  2.00732610_wp,  2.19660010_wp,  0.00000000_wp, &
   &  2.17560270_wp,  2.25012276_wp,  2.00000000_wp,  2.02622199_wp,  2.14423571_wp,  3.00000000_wp, &
   &  1.71820208_wp,  1.73087918_wp,  3.00000000_wp,  1.77892599_wp,  1.92370137_wp,  2.50000000_wp, &
   &  2.12226184_wp,  2.22924766_wp,  2.50000000_wp,  1.69051709_wp,  2.45637163_wp,  3.00000000_wp],&
   & shape(p_ceh_h0k))

   !> Empirical atomic radii for calculation of the coordination number # MM/TF, Jan 10, 2024
   real(wp), parameter :: ceh_cov_radii(max_elem) = reshape([&
   &  0.70454446_wp,  1.12942839_wp,  1.75906344_wp,  1.61279399_wp,  1.53352314_wp,  1.34821062_wp, &
   &  1.12818135_wp,  1.07469166_wp,  1.01053294_wp,  1.35741744_wp,  2.25430671_wp,  2.12163656_wp, &
   &  2.07833662_wp,  2.18564258_wp,  1.93617553_wp,  1.74102279_wp,  1.60309436_wp,  1.85217291_wp, &
   &  2.76057118_wp,  2.29947144_wp,  2.46980191_wp,  2.47057003_wp,  2.38967937_wp,  2.45592320_wp, &
   &  2.19679822_wp,  2.01859168_wp,  1.90428718_wp,  1.84088175_wp,  1.77394071_wp,  2.03564651_wp, &
   &  2.16507848_wp,  2.17108951_wp,  2.18317342_wp,  1.96885512_wp,  1.89580342_wp,  1.78002221_wp, &
   &  2.70918820_wp,  2.47249923_wp,  2.61176805_wp,  2.77142916_wp,  2.61045521_wp,  2.69471963_wp, &
   &  2.37931801_wp,  2.27987707_wp,  1.89965079_wp,  1.81446963_wp,  1.98089073_wp,  2.28727307_wp, &
   &  2.28305085_wp,  2.52468506_wp,  2.42847953_wp,  2.57997045_wp,  2.33443589_wp,  2.04024104_wp, &
   &  2.80381282_wp,  2.68557728_wp,  2.80412330_wp,  2.69940600_wp,  2.69983859_wp,  2.70027118_wp, &
   &  2.70070376_wp,  2.70113635_wp,  2.70156893_wp,  2.70200152_wp,  2.70243411_wp,  2.70286669_wp, &
   &  2.70329928_wp,  2.70373186_wp,  2.70416445_wp,  2.70459704_wp,  2.70502962_wp,  2.46747525_wp, &
   &  2.57670384_wp,  2.64311747_wp,  2.54266254_wp,  2.25331426_wp,  1.98181019_wp,  1.89506292_wp, &
   &  2.08368458_wp,  2.27821890_wp,  2.60779481_wp,  2.26368523_wp,  2.42222713_wp,  2.59614264_wp, &
   &  2.66028539_wp,  2.58645405_wp],&
   & shape(ceh_cov_radii))

   !> Pauling EN normalized to EN(F)=1 as start values
   !> all hand optimized, SG 12/23-1/24
   !> Used for EN-scaled Coordination number in CEH
   real(wp), parameter :: pauling_en_ceh(max_elem) = (1d0/3.98d0) * [ &
     & 2.200_wp, 3.100_wp, &
     & 1.700_wp, 1.800_wp, 2.050_wp, 2.550_wp, 3.040_wp, 3.440_wp, 3.980_wp, 4.400_wp, & ! Li-Ne
     & 1.500_wp, 1.730_wp, 1.850_wp, 1.980_wp, 2.210_wp, 2.760_wp, 3.200_wp, 3.500_wp, & ! Na-Ar
     & 1.620_wp, 1.680_wp, & ! K,Ca
     &                     1.780_wp, 1.840_wp, 1.980_wp, 1.850_wp, 2.020_wp, & ! Sc-
     &                     2.000_wp, 2.090_wp, 2.200_wp, 2.110_wp, 1.730_wp, & ! -Zn
     &                     1.830_wp, 2.050_wp, 2.100_wp, 2.460_wp, 3.020_wp, 3.230_wp, & ! Ga-Kr
     & 1.600_wp, 1.650_wp, & ! Rb,Sr
     &                     1.850_wp, 1.780_wp, 1.940_wp, 1.850_wp, 2.090_wp, & ! Y-
     &                     2.140_wp, 2.460_wp, 2.800_wp, 2.410_wp, 1.740_wp, & ! -Cd
     &                     1.880_wp, 1.910_wp, 2.020_wp, 2.080_wp, 2.580_wp, 3.050_wp, & ! In-Xe
     & 1.450_wp, 1.580_wp, & ! Cs,Ba
     &           1.730_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, & ! La-Eu
     &           1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, 1.650_wp, & ! Gd-Yb
     &                     1.650_wp, 1.750_wp, 1.920_wp, 2.030_wp, 2.050_wp, & ! Lu-
     &                     2.350_wp, 2.450_wp, 2.780_wp, 2.530_wp, 1.600_wp, & ! Hg-
     &                     1.650_wp, 2.270_wp, 2.040_wp, 2.040_wp, 2.230_wp, 2.300_wp ] !   Tl-Rn

   !> Angular momentum-specific scaling factors for H0 # MM/TF, Jan 10, 2024
   real(wp), parameter   :: kll(1:3) = [0.6594_wp, 0.8077_wp, 1.1344_wp]
   !> Conversion constant
   real(wp), parameter   :: kt = 3.166808578545117e-06_wp

   !> Specification of the CEH hamiltonian
   type, extends(tb_h0spec) :: ceh_h0spec
   contains
      !> Generator for the self energy / atomic levels of the Hamiltonian
      procedure :: get_selfenergy
      !> Generator for the coordination number dependent shift of the self energy
      procedure :: get_cnshift
      !> Generator for the coordination number dependent shift of the self energy
      procedure :: get_cnenshift
      !> Generator for the enhancement factor to for scaling Hamiltonian elements
      procedure :: get_hscale
      !> Generator for the polynomial parameters for the distant dependent scaling
      procedure :: get_shpoly
      !> Generator for the reference occupation numbers of the atoms
      procedure :: get_reference_occ
      !> Generator for the diatomic frame scaling factors
      procedure :: get_diat_scale
   end type ceh_h0spec

   interface ceh_h0spec
      module procedure :: new_ceh_h0spec
   end interface ceh_h0spec

contains


   subroutine new_ceh_calculator(calc,mol)
      !> Instance of the CEH evaluator
      type(xtb_calculator), intent(out) :: calc
      type(structure_type), intent(in)  :: mol

      call add_ceh_basis(calc, mol)
      call add_ncoord(calc, mol)
      call add_ncoord_en(calc, mol)
      call add_hamiltonian(calc, mol)

   end subroutine new_ceh_calculator


   subroutine add_ceh_basis(calc, mol)
      !> Instance of the CEH evaluator
      type(xtb_calculator), intent(inout) :: calc
      !> Molecular structure data
      type(structure_type), intent(in) :: mol

      integer :: isp, izp, ish, stat, ng, il
      integer, allocatable :: nsh_id(:)
      integer :: ang_idx(0:2), ortho(max_shell)
      type(cgto_type), allocatable :: cgto(:, :)

      nsh_id = nshell(mol%num)
      allocate(cgto(maxval(nsh_id), mol%nid))
      do isp = 1, mol%nid
         ang_idx = 0
         ortho = 0
         izp = mol%num(isp)
         do ish = 1, nsh_id(isp)
            il = ang_shell(ish, izp)
            ng = number_of_primitives(ish, izp)
            if (ang_idx(il) > 0) then
               ortho(ish) = ang_idx(il)
            else
               ang_idx(il) = ish
            end if
            call slater_to_gauss(ng, principal_quantum_number(ish, izp), il, &
            & slater_exponent(ish, izp), cgto(ish, isp), .true., stat)
         end do

         do ish = 1, nsh_id(isp)
            if (ortho(ish) > 0) then
               call orthogonalize(cgto(ortho(ish), isp), cgto(ish, isp))
            end if
         end do
      end do

      call new_basis(calc%bas, mol, nsh_id, cgto, 1.0_wp)

   end subroutine add_ceh_basis


   subroutine add_ncoord(calc, mol)
      !> Instance of the CEH evaluator
      type(xtb_calculator), intent(inout) :: calc
      !> Molecular structure data
      type(structure_type), intent(in) :: mol

      call new_ncoord(calc%ncoord, mol, cn_type="erf", &
      & rcov=ceh_cov_radii(mol%num))
   end subroutine add_ncoord


   subroutine add_ncoord_en(calc, mol)
      !> Instance of the CEH evaluator
      type(xtb_calculator), intent(inout) :: calc
      !> Molecular structure data
      type(structure_type), intent(in) :: mol

      call new_ncoord(calc%ncoord_en, mol, cn_type="erf_en", &
      & rcov=ceh_cov_radii(mol%num), en=pauling_en_ceh(mol%num))
   end subroutine add_ncoord_en


   subroutine add_hamiltonian(calc, mol)
      !> Instance of the CEH evaluator
      type(xtb_calculator), intent(inout) :: calc
      !> Molecular structure data
      type(structure_type), intent(in) :: mol

      call new_hamiltonian(calc%h0, mol, calc%bas, new_ceh_h0spec(mol))

   end subroutine add_hamiltonian


   pure function new_ceh_h0spec(mol) result(self)
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Instance of the Hamiltonian specification
      type(ceh_h0spec) :: self

   end function new_ceh_h0spec


   !> Generator for the enhancement factor to for scaling Hamiltonian elements
   subroutine get_hscale(self, mol, bas, hscale)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Scaling parameters for the Hamiltonian elements
      real(wp), intent(out) :: hscale(:, :, :, :)

      integer :: isp, jsp, izp, jzp, ish, jsh, il, jl
      real(wp) :: km

      hscale(:, :, :, :) = 0.0_wp

      do isp = 1, mol%nid
         izp = mol%num(isp)
         do jsp = 1, mol%nid
            jzp = mol%num(jsp)
            do ish = 1, bas%nsh_id(isp)
               il = bas%cgto(ish, isp)%ang
               do jsh = 1, bas%nsh_id(jsp)
                  jl = bas%cgto(jsh, jsp)%ang
                  km = ( kll(il + 1) + kll(jl + 1) )
                  hscale(jsh, ish, jsp, isp) = 0.5_wp * km
               end do
            end do
         end do
      end do

   end subroutine get_hscale


   !> Generator for the self energy / atomic levels of the Hamiltonian
   subroutine get_selfenergy(self, mol, bas, selfenergy)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Self energy / atomic levels
      real(wp), intent(out) :: selfenergy(:, :)

      integer :: isp, izp, ish, iat

      selfenergy(:, :) = 0.0_wp

      do isp = 1, mol%nid
         izp = mol%num(isp)
         do ish = 1, bas%nsh_id(isp)
            iat = bas%ao2at(ish)
            selfenergy(ish, isp) = p_ceh_selfenergy(ish, izp)
         end do
      end do
   end subroutine get_selfenergy


   !> Generator of the coordination number dependent shift of the self energy
   subroutine get_cnshift(self, mol, bas, kcn)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Coordination number dependent shift
      real(wp), intent(out) :: kcn(:, :)

      integer :: isp, izp, ish

      kcn(:, :) = 0.0_wp

      do isp = 1, mol%nid
         izp = mol%num(isp)
         do ish = 1, bas%nsh_id(isp)
            kcn(ish, isp) = p_ceh_kcn(ish, izp)
         end do
      end do

   end subroutine get_cnshift


   !> Generator of the coordination number dependent shift of the self energy
   subroutine get_cnenshift(self, mol, bas, kcn_en)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Coordination number dependent shift
      real(wp), intent(out) :: kcn_en(:, :)

      integer :: isp, izp, ish

      kcn_en(:, :) = 0.0_wp

      do isp = 1, mol%nid
         izp = mol%num(isp)
         do ish = 1, bas%nsh_id(isp)
            kcn_en(ish, isp) = p_ceh_kcn_en(ish, izp)
         end do
      end do

   end subroutine get_cnenshift


   subroutine get_reference_occ(self, mol, bas, refocc)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Reference occupation numbers
      real(wp), intent(out) :: refocc(:, :)
      logical, allocatable  :: valence(:,:)

      integer :: isp, izp, ish, il, mshell
      integer :: ang_idx(0:2)

      allocate(valence(3, mol%nid))
      do isp = 1, mol%nid
         ang_idx = 0
         izp = mol%num(isp)
         do ish = 1, nshell(izp)
            il = ang_shell(ish, izp)
            valence(ish, isp) = ang_idx(il) == 0
            if (valence(ish, isp)) ang_idx(il) = ish
         end do
      end do

      mshell = maxval(bas%nsh_id)
      refocc(:, :) = 0.0_wp
      do isp = 1, mol%nid
         izp = mol%num(isp)
         do ish = 1, bas%nsh_id(isp)
            if (valence(ish, isp)) then
               refocc(ish, isp) = reference_occ(bas%cgto(ish, isp)%ang+1, izp)
            else
               refocc(ish, isp) = 0.0_wp
            end if
         end do
      end do

   end subroutine get_reference_occ


   !> Generator for the polynomial parameters for the distant dependent scaling (Not in CEH)
   subroutine get_shpoly(self, mol, bas, shpoly)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Polynomial parameters for distant dependent scaleing
      real(wp), intent(out) :: shpoly(:, :)

      integer :: isp, izp, ish

      shpoly(:, :) = 0.0_wp

   end subroutine get_shpoly


   !> Stub implementation of the diatomic frame scaling factor generator
   subroutine get_diat_scale(self, mol, bas, ksig, kpi, kdel)
      !> Instance of the Hamiltonian specification
      class(ceh_h0spec), intent(in) :: self
      !> Molecular structure data
      type(structure_type), intent(in) :: mol
      !> Basis set information
      type(basis_type), intent(in) :: bas
      !> Quadratic partial charge dependent shift
      real(wp), intent(out) :: ksig(:, :)
      !> Quadratic partial charge dependent shift
      real(wp), intent(out) :: kpi(:, :)
      !> Quadratic partial charge dependent shift
      real(wp), intent(out) :: kdel(:, :)

      integer :: isp, izp, jsp, jzp

      ksig(:, :) = 0.0_wp
      kpi(:, :) = 0.0_wp
      kdel(:, :) = 0.0_wp

      do isp = 1, mol%nid
         izp = mol%num(isp)
         do jsp = 1, mol%nid
            jzp = mol%num(jsp)
            ksig(isp, jsp) = 2.0_wp / (1.0_wp / p_ceh_h0k(1,izp) &
            & + 1.0_wp / p_ceh_h0k(1,jzp) )
            kpi (isp, jsp) = 2.0_wp / (1.0_wp / p_ceh_h0k(2,izp) &
            & + 1.0_wp / p_ceh_h0k(2,jzp) )
            kdel(isp, jsp) = 2.0_wp / (1.0_wp / p_ceh_h0k(3,izp) &
            & + 1.0_wp / p_ceh_h0k(3,jzp) )
         end do
      end do

   end subroutine get_diat_scale

end module tblite_ceh_ceh
